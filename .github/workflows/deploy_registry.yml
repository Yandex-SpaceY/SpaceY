name: Deploy_Registry

on:
  push:
    branches:
      - test-deploy

jobs:
  push-docker-image:
    name: Build and push images to yandex registry
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Build images
        run: | 
          npm ci
          REGISTRY_ID=${{ secrets.REGISTRY_ID }} PORT=${{ secrets.POSTGRES_PORT }} POSTGRES_DB=${{ secrets.POSTGRES_DB }} POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} POSTGRES_PORT=${{ secrets.POSTGRES_PORT }} POSTGRES_USER=${{ secrets.POSTGRES_USER }} POSTGRES_URL=${{ secrets.POSTGRES_URL }} docker-compose build
          docker images
      - name: Yandex Image Registry Action
        uses: pyropy/yandex-cloud-image-registry@v0.8-alpha
        with:
          DOCKER_CONTEXT: .
          # JSON key generated by Yandex Cloud CLI
          YC_SERVICE_ACCOUNT_KEY_FILE: 
          YC_IMG_REGISTRY_ID: ${{ secrets.REGISTRY_ID }}
          DOCKER_IMG_NAME: space-y-server
          DOCKER_IMG_TAG: cr.yandex/${{ secrets.REGISTRY_ID }}/space-y-server:latest
      - name: executing remote ssh commands using ssh key
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          script: docker tag space-y-server "cr.yandex/${{ secrets.REGISTRY_ID }}/space-y-server:latest" && docker tag postgres "cr.yandex/${{ secrets.REGISTRY_ID }}/postgres:latest" && docker push "cr.yandex/${{ secrets.REGISTRY_ID }}/space-y-server:latest" && docker push "cr.yandex/${{ secrets.REGISTRY_ID }}/postgres:latest"
